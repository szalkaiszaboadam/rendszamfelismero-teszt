<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Végleges Rendszám Felismerő</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <style>
        /* Stílus ugyanaz, mint eddig, csak mobilon szebb */
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: #121212; color: white; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 10px; touch-action: manipulation; }
        h2 { margin: 10px 0; font-size: 1.5rem; }
        #container { position: relative; width: 100%; max-width: 500px; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        video { width: 100%; display: block; background: #222; object-fit: cover; }
        .guide {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 85%; height: 70px; border: 3px solid #00ff00;
            box-shadow: 0 0 0 1000px rgba(0,0,0,0.7); pointer-events: none; z-index: 10;
        }
        .controls { margin: 20px 0; width: 100%; max-width: 500px; text-align: center; }
        button { 
            width: 100%; padding: 18px; font-size: 1.3rem; font-weight: bold; letter-spacing: 1px;
            background: #007bff; color: white; border: none; border-radius: 12px; cursor: pointer; transition: background 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        button:active { background: #0056b3; transform: translateY(2px); }
        button:disabled { background: #555; color: #aaa; cursor: not-allowed; }
        #result-area {
            background: #222; width: 100%; max-width: 500px; padding: 20px;
            border-radius: 15px; text-align: center; border: 2px solid #444; box-sizing: border-box;
        }
        #status { color: #aaa; font-size: 0.9rem; margin-bottom: 5px; }
        .plate-display { font-size: 2.8rem; font-weight: 800; color: #00ff00; margin: 10px 0; letter-spacing: 3px; font-family: 'Courier New', Courier, monospace; text-shadow: 0 0 10px rgba(0,255,0,0.5); }
        #debug-canvas { border: 2px solid #555; width: 100%; height: auto; margin-top: 15px; background: white; border-radius: 5px; }
        .label { font-size: 0.8rem; color: #888; margin-top: 15px; text-transform: uppercase; letter-spacing: 1px; }
    </style>
</head>
<body>

    <h2>Rendszám Olvasó V3 (Végleges)</h2>

    <div id="container">
        <video id="video" autoplay playsinline></video>
        <div class="guide"></div>
    </div>

    <div class="controls">
        <button id="scanBtn">BEOLVASÁS</button>
    </div>

    <div id="result-area">
        <div id="status">Kamera indítása...</div>
        <div class="plate-display" id="result">---</div>
        
        <div class="label">Amit a gép "lát" (tisztított kép):</div>
        <canvas id="debug-canvas"></canvas>
    </div>

    <script>
        const video = document.getElementById('video');
        const scanBtn = document.getElementById('scanBtn');
        const resultDiv = document.getElementById('result');
        const statusDiv = document.getElementById('status');
        const debugCanvas = document.getElementById('debug-canvas');
        
        // Tesseract worker globális inicializálása a gyorsabb működésért
 let worker = null;
async function initWorker() {
    statusDiv.innerText = "OCR motor hangolása...";
    worker = await Tesseract.createWorker();
    await worker.loadLanguage('eng');
    await worker.initialize('eng');
    
    await worker.setParameters({
        tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789',
        // KRITIKUS: Az egysoros mód beállítása (PSM 7)
        tessedit_pageseg_mode: '7', 
    });
    statusDiv.innerText = "Készen áll!";
}

        async function startCamera() {
            try {
                // Megpróbáljuk a legjobb hátsó kamerát elérni
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: { ideal: "environment" },
                        width: { ideal: 1920 }, // Nagyobb felbontás jobb eredmény
                        height: { ideal: 1080 }
                    }
                });
                video.srcObject = stream;
                // Amint a videó elindul, betöltjük a workert
                video.onloadedmetadata = () => { initWorker(); };
            } catch (err) {
                statusDiv.innerText = "Hiba: Adj hozzáférést a kamerához!";
                console.error(err);
            }
        }

        // Képfeldolgozás: Bináris (Fekete-Fehér) Thresholding
        // Ez a titka a tiszta képnek, amit küldtél!
        function preprocessImage(ctx, width, height) {
            const imageData = ctx.getImageData(0, 0, width, height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                // Szürkeárnyalat kiszámítása
                const brightness = 0.3 * data[i] + 0.59 * data[i + 1] + 0.11 * data[i + 2];
                
                // Küszöbölés: Ami sötét, legyen koromfekete, ami világos, legyen hófehér.
                // A 110-es érték jó kompromisszum a legtöbb fényviszonyhoz.
                const val = brightness < 110 ? 0 : 255;
                
                data[i] = data[i+1] = data[i+2] = val;
            }
            // Visszaírjuk a módosított pixeleket
            ctx.putImageData(imageData, 0, 0);
        }

        scanBtn.onclick = async () => {
    if (!worker) return;
    scanBtn.disabled = true;
    statusDiv.innerText = "Elemzés...";

    const dctx = debugCanvas.getContext('2d');
    const scaleY = video.videoHeight / video.clientHeight;
    const cropW = video.videoWidth * 0.85;
    const cropH = 80 * scaleY;
    const cropX = (video.videoWidth - cropW) / 2;
    const cropY = (video.videoHeight - cropH) / 2;

    debugCanvas.width = cropW;
    debugCanvas.height = cropH;
    dctx.drawImage(video, cropX, cropY, cropW, cropH, 0, 0, cropW, cropH);
    preprocessImage(dctx, cropW, cropH);

    try {
        const { data: { text } } = await worker.recognize(debugCanvas);
        
        // Nyers tisztítás
        let raw = text.replace(/[^A-Z0-9]/g, "").trim();
        console.log("Nyers beolvasás:", raw);

        let finalPlate = "???";
        let statusText = "Nem felismerhető minta";

        // 1. ELŐSZÖR: Keressük az új típusú mintát (pl. TXAA123)
        // Megengedjük, hogy a címer miatt legyen közte egy felesleges karakter
        const newMatch = raw.match(/([A-Z]{2})[A-Z0-9]?([A-Z]{2})(\d{3})/);
        
        // 2. MÁSODSZOR: Keressük a régi típust (pl. RJN620)
        const oldMatch = raw.match(/([A-Z]{3})(\d{3})/);

        if (newMatch) {
            // Ha az új típust találta (a címer karakterét [group 2] átugorjuk)
            finalPlate = `${newMatch[1]}-${newMatch[2]}-${newMatch[3]}`;
            statusText = "Új típusú rendszám!";
        } else if (oldMatch) {
            // Ha a régit találta
            finalPlate = `${oldMatch[1]}-${oldMatch[2]}`;
            statusText = "Régi típusú rendszám!";
        } else {
            // Ha egyik se, de van elég karakter, kiírjuk nyersen
            finalPlate = raw.substring(0, 8);
        }

        resultDiv.innerText = finalPlate;
        statusDiv.innerText = statusText + " (Nyers: " + raw + ")";
        resultDiv.style.color = (finalPlate !== "???") ? "#00ff00" : "#ffaa00";

    } catch (e) {
        statusDiv.innerText = "Hiba történt.";
    } finally {
        scanBtn.disabled = false;
    }
};

        
        startCamera();
    </script>
</body>
</html>